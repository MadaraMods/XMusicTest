name: Build and Send APK to Telegram

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      build_timestamp: ${{ steps.timestamp.outputs.timestamp }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate timestamp
      id: timestamp
      run: echo "timestamp=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Build APK
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Find APK file
      run: |
        find . -name "*.apk" -type f | head -1 > apk_path.txt
        echo "APK found at: $(cat apk_path.txt)"

  notify:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Send Success to Telegram
      if: success()
      env:
        BOT_TOKEN: "7560748316:AAEUvfZbKbOzKZmKkEF-wJZ1f49fAgBGSK4"
        CHAT_ID: "3126191562"
        COMMIT_ID: ${{ github.event.head_commit.id }}
        COMMIT_URL: ${{ github.event.head_commit.url }}
        COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        BUILD_TIMESTAMP: ${{ needs.build.outputs.build_timestamp }}
      run: |
        APK_PATH=$(cat apk_path.txt)
        APK_NAME=$(basename "$APK_PATH")
        COMMIT_SHORT=${COMMIT_ID:0:7}
        
        curl -F chat_id="$CHAT_ID" \
             -F document=@"$APK_PATH" \
             -F caption="✅ APK Build BAŞARILI! 🎉

📱 APK: $APK_NAME
🏗️ Repo: ${{ github.repository }}
🔧 Branch: ${{ github.ref }}
🔖 Commit: $COMMIT_SHORT
📝 Message: $COMMIT_MESSAGE
🔗 Commit URL: $COMMIT_URL
⏰ Build Time: $BUILD_TIMESTAMP

İndir ve test et! 👇" \
             "https://api.telegram.org/bot$BOT_TOKEN/sendDocument"

    - name: Send Failure to Telegram
      if: failure()
      env:
        BOT_TOKEN: "7560748316:AAEUvfZbKbOzKZmKkEF-wJZ1f49fAgBGSK4"
        CHAT_ID: "3126191562"
        COMMIT_ID: ${{ github.event.head_commit.id }}
        COMMIT_URL: ${{ github.event.head_commit.url }}
        COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        BUILD_TIMESTAMP: ${{ needs.build.outputs.build_timestamp }}
      run: |
        COMMIT_SHORT=${COMMIT_ID:0:7}
        
        curl -s -X POST \
          "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
          -d "chat_id=$CHAT_ID" \
          -d "text=❌ APK Build BAŞARISIZ! 🚨

🏗️ Repo: ${{ github.repository }}
🔧 Branch: ${{ github.ref }}
🔖 Commit: $COMMIT_SHORT
📝 Message: $COMMIT_MESSAGE
🔗 Commit URL: $COMMIT_URL
⏰ Build Time: $BUILD_TIMESTAMP
🔍 Hata: Build işlemi başarısız oldu

Lütfen GitHub Actions loglarını kontrol et! 📋" \
          -d "parse_mode=HTML"