name: Build and Send APK to Telegram

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Build APK
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Find APK file
      run: |
        find . -name "*.apk" -type f | head -1 > apk_path.txt
        echo "APK found at: $(cat apk_path.txt)"

    - name: Send Success to Telegram
      if: success()
      env:
        BOT_TOKEN: "8245227298:AAGUKIoY7wMw-qpG8p6oFQdmNrmb1ZbxeBI"
        CHAT_ID: "3285651531"
      run: |
        APK_PATH=$(cat apk_path.txt)
        APK_NAME=$(basename "$APK_PATH")
        
        curl -F chat_id="$CHAT_ID" \
             -F document=@"$APK_PATH" \
             -F caption="✅ APK Build BAŞARILI! 🎉

📱 APK: $APK_NAME
🏗️ Repo: ${{ github.repository }}
🔧 Branch: ${{ github.ref }}
⏰ Time: $(date)

İndir ve test et! 👇" \
             "https://api.telegram.org/bot$BOT_TOKEN/sendDocument"

    - name: Send Failure to Telegram
      if: failure()
      env:
        BOT_TOKEN: "7560748316:AAEUvfZbKbOzKZmKkEF-wJZ1f49fAgBGSK4"
        CHAT_ID: "3126191562"
      run: |
        curl -s -X POST \
          "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
          -d "chat_id=$CHAT_ID" \
          -d "text=❌ APK Build BAŞARISIZ! 🚨

🏗️ Repo: ${{ github.repository }}
🔧 Branch: ${{ github.ref }}
⏰ Time: $(date)
🔍 Hata: Build işlemi başarısız oldu

Lütfen GitHub Actions loglarını kontrol et! 📋" \
          -d "parse_mode=HTML"